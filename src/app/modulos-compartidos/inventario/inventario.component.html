<div class="container mx-auto p-4">
  <div class="flex flex-col lg:flex-row gap-6">
    <!-- Sección principal (Tabla) -->
    <div class="flex-1">
      <div class="bg-white rounded-lg shadow-md p-6">
        <div class="flex justify-between items-center mb-6">
          <h1 class="text-2xl font-bold text-gray-800">Movimientos de Inventario</h1>
          
          <div class="flex items-center gap-4">
            <mat-form-field appearance="outline" class="w-48">
              <mat-label>Filtrar por categoría</mat-label>
              <mat-select [(value)]="categoriaSeleccionada" (selectionChange)="aplicarFiltro()">
                <mat-option value="Todos">Todas las categorías</mat-option>
                <mat-option *ngFor="let categoria of categorias" [value]="categoria">
                  {{ categoria }}
                </mat-option>
              </mat-select>
            </mat-form-field>

            <button mat-raised-button color="primary" (click)="abrirFormularioNuevo()">
              <mat-icon>add</mat-icon>
              <span class="ml-2">Nuevo Movimiento</span>
            </button>
          </div>
        </div>

        <div class="overflow-x-auto">
          <table mat-table [dataSource]="movimientosFiltrados" class="w-full">
            <ng-container matColumnDef="productoNombre">
              <th mat-header-cell *matHeaderCellDef>Producto</th>
              <td mat-cell *matCellDef="let m" class="font-medium">{{ m.productoNombre }}</td>
            </ng-container>

            <ng-container matColumnDef="categoria">
              <th mat-header-cell *matHeaderCellDef>Categoría</th>
              <td mat-cell *matCellDef="let m">{{ m.categoria }}</td>
            </ng-container>

            <ng-container matColumnDef="cantidad">
              <th mat-header-cell *matHeaderCellDef>Cantidad</th>
              <td mat-cell *matCellDef="let m">{{ m.cantidad }}</td>
            </ng-container>

            <ng-container matColumnDef="ubicacion">
              <th mat-header-cell *matHeaderCellDef>Ubicación</th>
              <td mat-cell *matCellDef="let m">{{ m.ubicacion }}</td>
            </ng-container>

            <ng-container matColumnDef="observacion">
              <th mat-header-cell *matHeaderCellDef>Observación</th>
              <td mat-cell *matCellDef="let m">{{ m.observacion }}</td>
            </ng-container>

            <ng-container matColumnDef="tipo">
              <th mat-header-cell *matHeaderCellDef>Tipo</th>
              <td mat-cell *matCellDef="let m">
                <span [class.text-green-600]="m.tipo === 'INGRESO'" 
                      [class.text-red-600]="m.tipo === 'SALIDA'">
                  {{ m.tipo }}
                </span>
              </td>
            </ng-container>

            <ng-container matColumnDef="fecha">
              <th mat-header-cell *matHeaderCellDef>Fecha</th>
              <td mat-cell *matCellDef="let m">{{ m.fecha | date:'dd/MM/yyyy' }}</td>
            </ng-container>

            <ng-container matColumnDef="acciones">
              <th mat-header-cell *matHeaderCellDef>Acciones</th>
              <td mat-cell *matCellDef="let m">
                <button *ngIf="usuarioEsAdmin" mat-icon-button color="accent" 
                        (click)="editarMovimiento(m)" matTooltip="Editar">
                  <mat-icon>edit</mat-icon>
                </button>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="columnasTabla" class="bg-gray-50"></tr>
            <tr mat-row *matRowDef="let row; columns: columnasTabla;" 
                class="hover:bg-gray-50 transition-colors"></tr>
          </table>
        </div>
      </div>
    </div>

    <!-- Formulario lateral -->
    <div class="w-full lg:w-96" *ngIf="editando">
      <div class="bg-white rounded-lg shadow-md p-6 sticky top-4">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xl font-semibold text-gray-800">
            {{ formularioEdicion.value.id ? 'Editar' : 'Nuevo' }} Movimiento
          </h2>
          <button mat-icon-button (click)="cancelarEdicion()">
            <mat-icon>close</mat-icon>
          </button>
        </div>

        <form [formGroup]="formularioEdicion" (ngSubmit)="guardarCambios()" class="space-y-4">
          <mat-form-field appearance="outline" class="w-full">
            <mat-label>Producto</mat-label>
            <mat-select formControlName="productoId" required>
              <mat-option *ngFor="let producto of productos" [value]="producto.id">
                {{ producto.nombre }}
              </mat-option>
            </mat-select>
            <mat-error>Seleccione un producto</mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="w-full">
            <mat-label>Categoría</mat-label>
            <input matInput [value]="productoSeleccionado?.categoria || 'Seleccione un producto'" readonly>
          </mat-form-field>

          <div class="grid grid-cols-2 gap-4">
            <mat-form-field appearance="outline" class="w-full">
              <mat-label>Cantidad</mat-label>
              <input matInput type="number" min="1" formControlName="cantidad" required>
              <mat-error>Cantidad inválida</mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline" class="w-full">
              <mat-label>Tipo</mat-label>
              <mat-select formControlName="tipo" required>
                <mat-option value="INGRESO">Ingreso</mat-option>
                <mat-option value="SALIDA">Salida</mat-option>
              </mat-select>
            </mat-form-field>
          </div>

          <mat-form-field appearance="outline" class="w-full">
            <mat-label>Ubicación</mat-label>
            <input matInput formControlName="ubicacion" required>
            <mat-error>Ingrese una ubicación</mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="w-full">
            <mat-label>Observación</mat-label>
            <textarea matInput formControlName="observacion" rows="2" required></textarea>
            <mat-error>Ingrese una observación</mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="w-full">
            <mat-label>Fecha</mat-label>
            <input matInput type="date" formControlName="fecha" required>
          </mat-form-field>

          <div class="flex justify-end gap-3 pt-2">
            <button mat-stroked-button color="warn" type="button" 
                    (click)="cancelarEdicion()" class="flex-1">
              Cancelar
            </button>
            <button mat-raised-button color="primary" type="submit" 
                    [disabled]="formularioEdicion.invalid" class="flex-1">
              Guardar
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>